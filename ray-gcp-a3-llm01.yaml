# ray-gcp-a3-llm01.yaml
cluster_name: ray-a3-mega

# Max number of *worker nodes* (A3s) in addition to the head.
max_workers: 8

# Kill idle workers after this many minutes (head is never auto-killed).
idle_timeout_minutes: 10

provider:
  type: gcp
  region: us-central1
  availability_zone: us-central1-a
  project_id: "project-for-deniz"
  # IMPORTANT: you're running ray up from outside GCP, so use external IPs.
  use_internal_ips: false

auth:
  # This must match the Linux username baked into your image.
  ssh_user: denizyuret
  # Ray creates and uses ~/.ssh/ray-autoscaler_* by default, so we can omit ssh_private_key.

available_node_types:
  ray_head_default:
    # Logical Ray resources on the head (you mostly care about CPUs here).
    resources: {"CPU": 16}
    node_config:
      machineType: "n2-standard-16"
      disks:
        - boot: true
          autoDelete: true
          type: PERSISTENT
          initializeParams:
            diskSizeGb: 256
            # Correct Compute Engine diskType URI
            diskType: "projects/project-for-deniz/zones/us-central1-a/diskTypes/pd-balanced"
            # Your custom image
            sourceImage: "projects/project-for-deniz/global/images/llm02-a3-disk-image"

  a3_megagpu_worker:
    # Start with zero A3s; autoscaler can grow to 8 as needed.
    min_workers: 0
    max_workers: 8
    # Ray resources for one A3: 8 GPUs, ~208 vCPUs.
    resources: {"CPU": 208, "GPU": 8}
    node_config:
      machineType: "a3-megagpu-8g"
      disks:
        - boot: true
          autoDelete: true
          type: PERSISTENT
          initializeParams:
            diskSizeGb: 256
            diskType: "projects/project-for-deniz/zones/us-central1-a/diskTypes/pd-ssd"
            sourceImage: "projects/project-for-deniz/global/images/llm02-a3-disk-image"
      # FLEX_START scheduling for cheaper H100s (matches your template semantics)
      scheduling:
        provisioningModel: "FLEX_START"
        onHostMaintenance: "TERMINATE"
        automaticRestart: false
        instanceTerminationAction: "DELETE"
        maxRunDuration:
          seconds: "604800"   # 7 days
          nanos: 0

# The head will use ray_head_default
head_node_type: ray_head_default

# Youâ€™re not syncing any files for now; these are harmless defaults (copied from Ray example).
file_mounts: {}
cluster_synced_files: []
file_mounts_sync_continuously: False
rsync_exclude:
  - "**/.git"
  - "**/.git/**"
rsync_filter:
  - ".gitignore"

# No automatic software install; your image already has everything.
setup_commands: []
head_setup_commands: []
worker_setup_commands: []

# Standard Ray start commands from the official GCP example.
head_start_ray_commands:
  - ray stop
  - >
    ray start --head --port=6379
    --object-manager-port=8076
    --dashboard-host=0.0.0.0
    --autoscaling-config=~/ray_bootstrap_config.yaml

worker_start_ray_commands:
  - ray stop
  - >
    ray start --address=$RAY_HEAD_IP:6379
    --object-manager-port=8076
